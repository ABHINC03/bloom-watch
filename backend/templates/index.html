<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BloomWatch AI Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 2rem; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 2rem; width: 100%; max-width: 1200px; }
        h1 { color: #1a73e8; text-align: center; margin-bottom: 2rem; }
        h1 span { font-size: 1.2rem; color: #5f6368; display: block; font-weight: 400; }
        .results-section { display: none; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-top: 1rem; align-items: stretch; }
        .result-card { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; display: flex; flex-direction: column; }
        .result-card h2 { margin-top: 0; color: #1a73e8; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; }
        .result-card p { font-size: 1rem; line-height: 1.5; margin: 0.5rem 0; display: flex; align-items: center; }
        .result-card strong { color: #333; }
        .full-width-card { grid-column: 1 / -1; }
        #map-container { position: relative; }
        #map { height: 500px; width: 100%; border-radius: 8px; background-color: #e0e0e0; }
        #summary-card { background-color: #e8f0fe; }
        .legend-color { height: 18px; width: 18px; display: inline-block; margin-right: 10px; border: 1px solid #ccc; }
        #play-story-btn { background-color: #34a853; color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 20px; cursor: pointer; margin-top: 1rem; }
        #play-story-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #story-annotation { position: absolute; bottom: 30px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 5px; z-index: 1000; font-size: 0.9rem; max-width: 80%; display: none; transition: opacity 0.5s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>BloomWatch AI Tracker ðŸŒ¿<span>An Analysis of the 2023 California Superbloom</span></h1>
        
        <div id="results" class="results-section">
            <div class="result-card full-width-card" id="map-container">
                <h2>Interactive NDVI Animation</h2>
                <div id="map"></div>
                <div id="story-annotation"></div>
            </div>
            <div class="result-card full-width-card" id="summary-card">
                <h2>Summary & Impact</h2>
                <p>This analysis focuses on the 2023 superbloom event in Southern California, USA, using NASA's MODIS satellite data.</p>
                <p><strong>Key Finding:</strong> <span id="summary-finding"></span></p>
                <p><strong>Potential Impact:</strong> <span id="summary-impact"></span></p>
            </div>
            <div class="result-card">
                <h2>Phenology Analysis</h2>
                <p><strong>Start of Season:</strong> <span id="sos-date"></span></p>
                <p><strong>Peak of Season:</strong> <span id="pos-date"></span></p>
                <p><strong>End of Season:</strong> <span id="eos-date"></span></p>
            </div>
            <div class="result-card">
                <h2>Forecast</h2>
                <p><strong>Predicted Peak for <span id="next-year"></span>:</strong> <br><span id="forecast-date"></span></p>
            </div>
            <div class="result-card">
                <h2>Map Legend (NDVI)</h2>
                <p><span class="legend-color" style="background-color: #006837;"></span> High (0.8+): Dense Vegetation</p>
                <p><span class="legend-color" style="background-color: #78c679;"></span> Moderate (0.4-0.6): Grasslands/Bloom</p>
                <p><span class="legend-color" style="background-color: #ffffcc;"></span> Low (&lt;0.2): Bare Soil / Arid Areas</p>
            </div>
            <div class="result-card">
                <h2>Chart Labels</h2>
                <p><span class="legend-color" style="background-color: #34a853;"></span> SOS: Start of the growing season.</p>
                <p><span class="legend-color" style="background-color: #fbbc05;"></span> POS: Peak of the growing season.</p>
                <p><span class="legend-color" style="background-color: #ea4335;"></span> EOS: End of the growing season.</p>
            </div>
            <div class="result-card full-width-card" id="chart-container">
                <h2>NDVI Time Series</h2>
                <canvas id="ndvi-chart"></canvas>
                <div class="slider-container">
                    <label for="time-slider">Scrub through time:</label>
                    <input type="range" id="time-slider" min="0" max="100" value="0" disabled>
                    <button id="play-story-btn" disabled>Play Story</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const page_data = {{ page_data | tojson }};

        const timeSlider = document.getElementById('time-slider');
        const playStoryBtn = document.getElementById('play-story-btn');
        const storyAnnotation = document.getElementById('story-annotation');
        
        let chartInstance = null;
        let map = null;
        let storyData = {};
        let imageOverlay = null;
        let storyInterval = null;

        function playStory() {
            playStoryBtn.disabled = true;
            storyAnnotation.style.display = 'block';
            storyAnnotation.style.opacity = 1;
            let currentStep = 0;
            storyInterval = setInterval(() => {
                if (currentStep >= storyData.story.length) {
                    clearInterval(storyInterval);
                    storyAnnotation.style.opacity = 0;
                    setTimeout(() => {
                        storyAnnotation.style.display = 'none';
                        if (imageOverlay && storyData.gif_url) {
                            imageOverlay.setUrl(storyData.gif_url);
                        }
                    }, 500);
                    playStoryBtn.disabled = false;
                    return;
                }
                const step = storyData.story[currentStep];
                const frameIndex = step.index;
                timeSlider.value = frameIndex;
                const event = new Event('input');
                timeSlider.dispatchEvent(event);
                if (imageOverlay && storyData.frames[frameIndex]) {
                    imageOverlay.setUrl(`/static/results/${storyData.frames[frameIndex]}`);
                }
                storyAnnotation.textContent = step.annotation;
                currentStep++;
            }, 2500);
        }

        async function displayResults(data) {
            document.getElementById('results').style.display = 'grid';
            const phenologyData = data.analysis;
            
            document.getElementById('sos-date').textContent = phenologyData.start_of_season;
            document.getElementById('pos-date').textContent = phenologyData.peak_of_season;
            document.getElementById('eos-date').textContent = phenologyData.end_of_season;
            
            if (data.forecast.message) {
                document.getElementById('next-year').textContent = 'N/A';
                document.getElementById('forecast-date').textContent = data.forecast.message;
            } else {
                document.getElementById('next-year').textContent = data.forecast.next_year;
                document.getElementById('forecast-date').textContent = data.forecast.predicted_pos_date;
            }
            
            document.getElementById('summary-finding').textContent = `The season peaked around ${phenologyData.peak_of_season}.`;
            document.getElementById('summary-impact').textContent = "Monitoring these shifts is crucial for understanding climate impacts on ecosystems and agriculture.";
            
            storyData = { frames: data.frames, story: [], gif_url: data.gif_url };
            
            if (map) map.remove();
            if (data.bounds && data.frames && data.frames.length > 0) {
                map = L.map('map').setView([data.bounds[0][0], data.bounds[0][1]], 8);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                const gifUrl = data.gif_url + '?t=' + new Date().getTime();
                imageOverlay = L.imageOverlay(gifUrl, data.bounds).addTo(map);
                map.fitBounds(data.bounds);
            } else {
                document.getElementById('map').innerHTML = '<p style="text-align:center; padding-top:200px;">Map overlay unavailable.</p>';
            }
            
            try {
                if(window.ChartAnnotation) Chart.register(window.ChartAnnotation);
                const labels = phenologyData.timeseries.map(d => d.date);
                const ndviValues = phenologyData.timeseries.map(d => d.mean_ndvi);
                const smoothedNdvi = phenologyData.timeseries.map(d => d.ndvi_smooth);
                const threshold = phenologyData.threshold_value;
                const ctx = document.getElementById('ndvi-chart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Mean NDVI', data: ndviValues, borderColor: 'rgba(40, 167, 69, 0.5)', borderWidth: 1, pointRadius: 3, pointBackgroundColor: 'rgba(40, 167, 69, 1)' },
                            { label: 'Smoothed Trend', data: smoothedNdvi, borderColor: 'rgba(26, 115, 232, 1)', backgroundColor: 'rgba(26, 115, 232, 0.1)', fill: true, tension: 0.2 },
                            { label: 'Green-up Threshold', data: Array(labels.length).fill(threshold), borderColor: 'rgba(255, 159, 64, 1)', borderDash: [5, 5], borderWidth: 2, pointRadius: 0 }
                        ]
                    },
                    options: {
                        scales: { 
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' } },
                            y: { beginAtZero: false, title: { display: true, text: 'NDVI' } } 
                        },
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            tooltip: { mode: 'index', intersect: false },
                            annotation: {
                                annotations: {
                                    sosLine: { type: 'line', scaleID: 'x', value: phenologyData.start_of_season, borderColor: '#34a853', borderWidth: 2, label: { content: 'SOS', display: phenologyData.start_of_season !== 'N/A', position: 'start', yAdjust: -10, font: { weight: 'bold' } } },
                                    posLine: { type: 'line', scaleID: 'x', value: phenologyData.peak_of_season, borderColor: '#fbbc05', borderWidth: 3, label: { content: 'POS', display: phenologyData.peak_of_season !== 'N/A', position: 'center', yAdjust: 20, font: { weight: 'bold' } } },
                                    eosLine: { type: 'line', scaleID: 'x', value: phenologyData.end_of_season, borderColor: '#ea4335', borderWidth: 2, label: { content: 'EOS', display: phenologyData.end_of_season !== 'N/A', position: 'end', yAdjust: -10, font: { weight: 'bold' } } }
                                }
                            }
                        }
                    }
                });
                
                const sosIndex = labels.indexOf(phenologyData.start_of_season);
                const posIndex = labels.indexOf(phenologyData.peak_of_season);
                const eosIndex = labels.indexOf(phenologyData.end_of_season);
                storyData.story.push({ index: 0, annotation: "The season begins..." });
                if (sosIndex > -1) storyData.story.push({ index: sosIndex, annotation: `Start of Season on ${phenologyData.start_of_season}.` });
                if (posIndex > -1) storyData.story.push({ index: posIndex, annotation: `Peak of Season on ${phenologyData.peak_of_season}.` });
                if (eosIndex > -1 && eosIndex !== posIndex) storyData.story.push({ index: eosIndex, annotation: `End of Season on ${phenologyData.end_of_season}.`});
                if (labels.length > 1) storyData.story.push({ index: labels.length - 1, annotation: "The observation period concludes." });

                timeSlider.max = labels.length - 1;
                timeSlider.value = 0;
                timeSlider.disabled = false;
                timeSlider.addEventListener('input', (event) => {
                    const index = parseInt(event.target.value, 10);
                    if (chartInstance.tooltip) {
                        chartInstance.tooltip.setActiveElements([{ datasetIndex: 0, index: index }]);
                        chartInstance.update();
                    }
                });
                playStoryBtn.disabled = false;
                playStoryBtn.onclick = playStory;
            } catch (error) {
                console.error("Chart error:", error);
                document.getElementById('chart-container').innerHTML = `<p style="text-align:center; color: red;">Chart could not be displayed.</p>`;
            }
            setTimeout(() => { if (map) map.invalidateSize(); }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (page_data && page_data.status === 'complete') {
                displayResults(page_data);
            } else {
                document.querySelector('.container').innerHTML = '<h1>Error</h1><p>Could not load pre-compiled data. Please check the server logs.</p>';
            }
        });
    </script>
</body>
</html>